<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Things About Kafka - spy16</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Things About Kafka"><meta itemprop=description content="I work with Kafka a lot and this post is a summary of some interesting facts about it."><meta itemprop=datePublished content="2020-02-20T20:20:20+00:00"><meta itemprop=dateModified content="2020-02-20T20:20:20+00:00"><meta itemprop=wordCount content="622"><meta itemprop=keywords content="til,kafka,"><meta property="og:title" content="Things About Kafka"><meta property="og:description" content="I work with Kafka a lot and this post is a summary of some interesting facts about it."><meta property="og:type" content="article"><meta property="og:url" content="https://spy16.in/posts/til-kafka/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-20T20:20:20+00:00"><meta property="article:modified_time" content="2020-02-20T20:20:20+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Things About Kafka"><meta name=twitter:description content="I work with Kafka a lot and this post is a summary of some interesting facts about it."><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://spy16.in/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://spy16.in/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://spy16.in/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://spy16.in/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://spy16.in/><img src="https://s.gravatar.com/avatar/07d369134a5308bfc99d1d5ae985e7f1?s=80" alt=spy16></a></div><h1 class=site-title><a href=https://spy16.in/>spy16</a></h1><div class=site-description><p>Poor attempts to convey my thoughts.</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/spy16 title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post><div class=post-head><div class=post-header><div class=meta><div class=date><span class=day>20</span>
<span class=rest>Feb 2020</span></div></div><div class=matter><h1 class=title>Things About Kafka</h1></div></div><div class=tags><ul class=flat><li><a href=/tags/til>til</a></li><li><a href=/tags/kafka>kafka</a></li></ul></div></div><button class=collapsible> ℹ️ &nbsp; Table of Contents</button><aside class="collapsible-content toc"><nav id=TableOfContents><ul><li><a href=#topic--partitions>Topic & Partitions</a></li><li><a href=#storage>Storage</a></li><li><a href=#replication>Replication</a></li><li><a href=#consumer>Consumer</a></li><li><a href=#references>References</a></li></ul></nav></aside><div class=markdown><p>I work with Kafka a lot and this post is a summary of some interesting facts about it.</p><h2 id=topic--partitions>Topic & Partitions</h2><ul><li>Topic is a logical grouping of partitions. But a partition is the storage unit in Kafka.</li><li>Producer can decide which partition to publish to by explicitly setting the partition on the message.</li><li>If producer does not set or sets <code>PartitionAny</code>, round-robin is used starting with an arbitrary partition.</li><li><code>offset</code> is maintained per partition and is a monotonically increasing number starting from 0. (new-id=last-id +1)</li><li>Topic is always an append-only log. Message already published cannot be modified or deleted by the producer.</li><li>Order of messages is guaranteed within a partition but not at topic level.</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:green># create a topic with 3 partitions and no replication.</span>
$ kafka-topics --create --topic til-kafka  --partitions 3 --replication-factor 1 --zookeeper localhost:2181

<span style=color:green># show the metadata for the topic fetched from the bootstrap server.</span>
$ kafkacat -b localhost:9092 -L -t til-kafka
</code></pre></div><h2 id=storage>Storage</h2><ul><li>Each partition corresponds to a log directory in <code>log.dirs</code> path. (i.e., <code>til-kafka-0</code>, <code>til-kafka-1</code>
and <code>til-kafka-2</code>)</li><li>Each partition directory
contains <a href=https://jaceklaskowski.gitbooks.io/apache-kafka/content/kafka-log-LogSegment.html>storage segments</a> each
consisting of 3 files:<ul><li><code>x.log</code> - actual record log. append only file.</li><li><code>x.index</code> - Index for fast access. Maintains record offset &lt;> file offset mapping in <code>x.log</code></li><li><code>x.timeindex</code> - Index for fast access. Maintains record offset &lt;> timestamp mapping.</li></ul></li><li>A new segment is created when the current active segment reaches the limit set using <code>log.segment.bytes</code></li><li>New segment name is always the last offset in the old segment + 1 which also means the name reflects the first record
offset in the segment.</li><li>The newly created segment becomes the active segment, and the writes are done only on the active segment.</li><li>Segments make it easy to enforce retention policy. The segment files with age greater than <code>log.retention.hours</code> can
be simply deleted.</li></ul><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:green># examine a log file in partition</span>
$ kafka-run-class kafka.tools.DumpLogSegments --deep-iteration --print-data-log <span style=color:#a31515>\
</span><span style=color:#a31515></span>  --files logs/til-kafka-0/00000000000000000000.log
</code></pre></div><h2 id=replication>Replication</h2><ul><li>Each topic has a replication factor that can be at max the number of brokers available at the time of creation of the
topic.</li><li>Configured number of copies of partitions of the topic are maintained with one acting as leader (accepts reads +
writes) and others acting as passive followers.</li><li>Kafka ensures only one replica of a topic is maintained on one node to provide <strong>fault-tolerance</strong>.</li><li>Replicas that are no more than <code>replica.lag.time.max.ms</code> behind the leader are called <code>In-Sync Replicas (ISR)</code>.</li><li>If the leader goes down, one of the ISRs is chosen as the new leader.</li></ul><h2 id=consumer>Consumer</h2><ul><li>Consumer is an entity that consumes records from partitions of a topic.</li><li>Consumers subscribe to one or more topics and run a <code>poll()</code> loop to read messages and get partition assignments.</li><li>Consumer group can be used to process records concurrently. Number of partitions decide how many active consumers can
exist at a time.<ul><li>If count(consumers) > count(partitions), consumers-partitions number of consumers will be idle.</li><li>If count(consumers) &lt; count(partitions), some consumers will be assigned more than 1 partition to read from.</li></ul></li><li>Based on <code>enable.auto.commit</code> config, consumers may commit messages automatically at interval set
by <code>auto.commit.interval.ms</code> or a manual <code>commit()</code> may be required. With auto-commit enabled, <code>at-least once</code>
delivery semantics apply.</li><li>Following steps can be taken to achieve required delivery semantics:<ol><li>at-least once: auto-commit enabled OR <code>poll()</code>, <code>process()</code> and then <code>commit()</code></li><li>at-most once: auto-commit false AND <code>poll()</code>, <code>commit()</code> and then <code>process()</code></li></ol></li><li>Consumer must process each message within <code>max.poll.interval.ms</code> time and invoke the next <code>poll()</code> to make sure the
broker does not end up assuming the consumer to be dead. If this does happen, a partition re-balance will occur
causing the consumer to be kicked out of the group. In addition to this, consumer must also send heartbeats within
every <code>session.timeout.ms</code> window. If violated, this also causes a re-balance.</li></ul><h2 id=references>References</h2><ol><li><a href=https://medium.com/@durgaswaroop/a-practical-introduction-to-kafka-storage-internals-d5b544f6925f>https://medium.com/@durgaswaroop/a-practical-introduction-to-kafka-storage-internals-d5b544f6925f</a></li><li><a href=https://jaceklaskowski.gitbooks.io/apache-kafka/content/kafka-log-TimeIndex.html>https://jaceklaskowski.gitbooks.io/apache-kafka/content/kafka-log-TimeIndex.html</a></li><li><a href=https://blog.knoldus.com/apache-kafka-topic-partitions-replicas-isr/>https://blog.knoldus.com/apache-kafka-topic-partitions-replicas-isr/</a></li><li><a href=https://www.confluent.io/blog/tutorial-getting-started-with-the-new-apache-kafka-0-9-consumer-client>https://www.confluent.io/blog/tutorial-getting-started-with-the-new-apache-kafka-0-9-consumer-client</a></li></ol></div><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='spy16-in',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the</a></noscript></div><div class="footer wrapper"><nav class=nav><div>2022 © Shivaprasad Bhat | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></div></body><script>var coll=document.getElementsByClassName("collapsible"),i;for(i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var a=this.nextElementSibling;a.style.display==="block"?a.style.display="none":a.style.display="block"})</script></html>